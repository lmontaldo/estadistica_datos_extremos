---
title: "Entrega: curso de datos extremales"
author: "Laura Montaldo, CI: 3.512.962-7"
date: "`r Sys.Date()`"
bibliography: references.bib  # Add this line
csl: acta-sociologica.csl
nocite: '@*'
output:
  pdf_document:
    fig_caption: true
    number_sections: yes
    latex_engine: xelatex
    keep_tex: true
    includes:
      in_header: header2.tex
documentclass: article
classoption: 12pt
lang: es
link-citations: yes
linkcolor: black
header-includes:
  - \usepackage{amsthm}
  - \usepackage{xcolor}
---

\newtheorem{theorem}{Teorema}
\newtheorem{mydefinition}{Definición}
\newtheorem{observation}{Observación}
\newtheorem{Corolario}{Corolario}

```{r setup, include=FALSE}
knitr::opts_chunk$set(comment = NA, include = FALSE)
```


```{r include=FALSE}
rm(list = ls())
```

\newpage

<!-- titulo-->

\thispagestyle{empty}

\maketitle

\newpage

<!-- indice -->

\tableofcontents

\newpage

<!-- abstract -->

# Resumen

Your abstract goes here.

\newpage



<!-- MOTIVACION Y OBJETIVO DEL ESTUDIO -->


# Motivación y objetivo del estudio
<!-- introduccion a eventos raros -->
Siguiendo a @notas_curso, se dice que tenemos datos extremos cuando cada dato corresponde al máximo o mínimo de varios registros. Son un caso particular de evento raro o gran desviación respecto a la media. Es por este motivo que en una gran variedad de dominios disciplinares suele ser de gran interés el estudio de datos extremos. Además, admiten diversos enfoques. La teoría clásica de estadística de datos extremos se basa en los trabajos de Fréchet, Gumbel, Weibull, Fisher, Tippett, Gnedenko, entre otros. En este estudio, el foco va a estar puesto en esquemas que extienden a las distribuciones extremales clásicas. En particular, se va a emplear el método Picos sobre el Umbral (POT)\footnote{Por sus siglas en inglés relaticas a  Peaks over Thresholds.}.



En este marco analítico, se pretende desarrollar un indicador de posibles crisis bursátiles a partir del índice $S\&P\;500$. En este sentido,  los índices de $S\&P$ son una familia de índices de renta variable\footnote{En inglés se llaman equity indices} diseñados para medir el rendimiento del mercado de acciones en Estados Unidos que cotizan en bolsas estadounidenses. Esta familia de índices está compuesta por una amplia variedad de índices basados en tamaño, sector y estilo. Los índices están ponderados por el criterio \textit{float-adjusted market capitalization} (FMC). Además, se disponen de índices ponderados de manera equitativa y con límite de capitalización de mercado, como es el caso del $S\&P\:500$. Este este sentido, el $S\&P 500$ entraría en el conjunto de índices ponderados por capitalización bursátil ajustada a la flotación (ver \href{https://www.spglobal.com/spdji/en/methodology/article/sp-us-indices-methodology/}{\textcolor{blue}{$S\&P$ Dow Jones Indices}}). El mismo  mide el rendimiento del segmento de gran capitalización del mercado estadounidense. Es considerado como un indicador representativo del mercado de renta variable de los Estados Unidos, y está compuesto por 500 empresas constituyentes.
 
Se busca crear un indicador de una posible crisis bursátil denominado Índice de Variación de Precios (IVP). Como variable de referencia de toma la relación de precios al cierre de ayer sobre la de hoy 

\begin{equation}
IVP_t=\left ( \frac{Precio_{t-1}}{Precio_t}\right ) -1,\quad\text{para}\; t=1,...,T 
\end{equation}
\vspace{0.5cm}

Interpretación del Indicador:

\begin{itemize}
\item Si el $IVP_t$    $\leq$ 0, el precio de cierre de hoy es mayor o igual que el de ayer, lo cual podría ser considerado una señal positiva.
\item Si el $IVP_t$ > 0, el precio de cierre de hoy es menor que el de ayer, lo cual podría considerarse una señal de alerta.
\end{itemize}

\newpage

En las siguiente figuras se muestra la evolución histórica desde la fecha 03/01/1928 hasta 08/12/2023 del precio al cierre del día del indicador S&P 500.




```{r include=FALSE}
source("utils/libraries.R")
library(VGAM)
library(patchwork)
library(evd)
library(lubridate)
library(dplyr)
library(ggplot2)
library(urca)
library(tseries)
library(reticulate)
library(zoo)
library(xts)
library(aTSA)
```


```{r include=FALSE}
# Check if the virtual environment exists
if (!virtualenv_exists("r-reticulate")) {
  # Create the virtual environment
  virtualenv_create("r-reticulate")
} else {
  # Virtual environment already exists
  print("Virtual environment 'r-reticulate' already exists.")
}
```


```{r include=FALSE}
py_path=py_config()$python
use_python(py_path)
print("In console run: py_path")
print("Go to Terminal (bash) to run the printed py_path to install packages in environment: /Users/lauramontaldo/.virtualenvs/r-reticulate/bin/python - m pip install pyextremes yfinance pandas" )
```


```{r include=FALSE}
# List of Python modules to check
modules_to_check <- c("pyextremes", "yfinance", "pandas")

# Check if each module is available
for (module in modules_to_check) {
  if (py_module_available(module)) {
    print(paste(module, "is installed and available"))
  } else {
    print(paste(module, "is not installed or not available"))
  }
}
```


```{r include=FALSE}
use_virtualenv("r-reticulate")
py_available(TRUE)
```


```{python}
import yfinance as yf
import pandas as pd

# Define the ticker symbol for the S&P 500
ticker_symbol = '^GSPC'

# Fetch historical data for the S&P 500
sp500 = yf.Ticker(ticker_symbol)

# Get historical market data
histsp500 = sp500.history(period='max')
histsp500.reset_index(inplace=True)
```

```{python}
print(histsp500.head())
```

```{r include=FALSE}
#df = read.csv('../../data/sp500_Closing_values.csv')
print("Datos descargados de yahoo!finance")
df=py$histsp500
head(df)
```

```{r include=FALSE}
str(df)
```

```{r include=FALSE}
df$Date <- as.Date(df$Date)
```




```{r include=FALSE}
# Create a new column 'relacion' with yesterday's price over today's price
df <- df %>%
  mutate(relacion = lag(Close) / Close)
```


```{r include=FALSE}
head(df)
```

```{r include=FALSE}
# Remove the first row
df <- df[-1, ]
```


```{r}
head(df)
```

