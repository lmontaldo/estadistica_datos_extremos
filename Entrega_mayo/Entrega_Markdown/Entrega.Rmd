---
title: "Entrega: curso de datos extremales"
author: "Laura Montaldo, CI: 3.512.962-7"
date: "`r Sys.Date()`"
bibliography: references.bib  # Add this line
csl: acta-sociologica.csl
nocite: '@*'
output:
  pdf_document:
    fig_caption: true
    number_sections: yes
    latex_engine: xelatex
    keep_tex: true
    includes:
      in_header: header2.tex
documentclass: article
classoption: 12pt
lang: es
link-citations: yes
linkcolor: black
header-includes:
  - \usepackage{amsthm}
  - \usepackage{xcolor}
---

\newtheorem{theorem}{Teorema}
\newtheorem{mydefinition}{Definición}
\newtheorem{observation}{Observación}
\newtheorem{Corolario}{Corolario}

```{r setup, include=FALSE}
knitr::opts_chunk$set(comment = NA)
```


```{r include=FALSE}
rm(list = ls())
```

\newpage

<!-- titulo-->

\thispagestyle{empty}

\maketitle

\newpage

<!-- indice -->

\tableofcontents

\newpage

<!-- abstract -->

# Resumen

Your abstract goes here.

\newpage



<!-- MOTIVACION Y OBJETIVO DEL ESTUDIO -->


# Motivación y objetivo del estudio
<!-- introduccion a eventos raros -->
Siguiendo a @notas_curso, se dice que tenemos datos extremos cuando cada dato corresponde al máximo o mínimo de varios registros. Son un caso particular de evento raro o gran desviación respecto a la media. Es por este motivo que en una gran variedad de dominios disciplinares suele ser de gran interés el estudio de datos extremos. Además, admiten diversos enfoques. La teoría clásica de estadística de datos extremos se basa en los trabajos de Fréchet, Gumbel, Weibull, Fisher, Tippett, Gnedenko, entre otros. En este estudio, el foco va a estar puesto en esquemas que extienden a las distribuciones extremales clásicas. En particular, se va a emplear el método Picos sobre el Umbral (POT)\footnote{Por sus siglas en inglés relaticas a  Peaks over Thresholds.}.



En este marco analítico, se pretende desarrollar un indicador de posibles crisis bursátiles a partir del índice $S\&P\;500$. En este sentido,  los índices de $S\&P$ son una familia de índices de renta variable\footnote{En inglés se llaman equity indices} diseñados para medir el rendimiento del mercado de acciones en Estados Unidos que cotizan en bolsas estadounidenses. Esta familia de índices está compuesta por una amplia variedad de indicadores basados en tamaño, sector y estilo. Los mismos pueden ser ponderados por el criterio \textit{float-adjusted market capitalization} (FMC) o de manera equitativa y con límite de capitalización de mercado, como es el caso del $S\&P\:500$. Este este sentido, el $S\&P 500$ entraría en el conjunto de índices ponderados por capitalización bursátil ajustada a la flotación (ver \href{https://www.spglobal.com/spdji/en/methodology/article/sp-us-indices-methodology/}{\textcolor{blue}{$S\&P$ Dow Jones Indices}}). El mismo  mide el rendimiento del segmento de gran capitalización del mercado estadounidense. Es considerado como un indicador representativo del mercado de renta variable de los Estados Unidos, y está compuesto por 500 empresas constituyentes.
 
Tomando la serie de datos diaria de Se busca crear un indicador de una posible crisis bursátil denominado Índice de Variación de Precios (IVP). Como variable de referencia de toma la relación de precios al cierre de ayer sobre la de hoy 

\begin{equation}
IVP_t=\left (\frac{Precio_{t-1}}{Precio_t}\right ) -1,\quad\text{para}\; t=1,...,T 
\end{equation}
\vspace{0.5cm}

Interpretación del Indicador:

\begin{itemize}
\item Si el $IVP_t$    $\leq$ 0, el precio de cierre de hoy es mayor o igual que el de ayer, lo cual podría ser considerado una señal positiva.
\item Si el $IVP_t$ > 0, el precio de cierre de hoy es menor que el de ayer, lo cual podría considerarse una señal de alerta.
\end{itemize}

```{r include=FALSE}
source("utils/libraries.R")
library(VGAM)
library(patchwork)
library(evd)
library(lubridate)
library(dplyr)
library(ggplot2)
library(urca)
library(tseries)
```

```{r include=FALSE}
#install.packages("reticulate")
library(reticulate)
virtualenv_create("r-reticulate")
py_available(TRUE)
#virtualenv_deactivate()
```

```{r}
path_py=py_config()$python
use_python(path_py)
```



```{r}
# /Library/Frameworks/Python.framework/Versions/3.11/bin/python3 -m pip install yfinance
# List of Python modules to check
modules_to_check <- c("pyextremes", "yfinance", "pandas")

# Check if each module is available
for (module in modules_to_check) {
  if (py_module_available(module)) {
    print(paste(module, "is installed and available"))
  } else {
    print(paste(module, "is not installed or not available"))
  }
}
```
```{python}
import yfinance as yf
import pandas as pd

# Define the ticker symbol for the S&P 500
ticker_symbol = '^GSPC'

# Fetch historical data for the S&P 500
sp500 = yf.Ticker(ticker_symbol)

# Get historical market data
histsp500 = sp500.history(period='max')
print(histsp500.columns)
```

```{r}
python_code <- "
import yfinance as yf
import pandas as pd

# Define the ticker symbol for the S&P 500
ticker_symbol = '^GSPC'

# Fetch historical data for the S&P 500
sp500 = yf.Ticker(ticker_symbol)

# Get historical market data
histsp500 = sp500.history(period='max')
print(histsp500.columns)

# Save the data to a CSV file
#histsp500.to_csv('data/sp500_Closing_values.csv')
"
py=py_run_string(python_code)
```

```{r}
py_run_string("x = 10"); py$x
```


```{r}
library(reticulate)
# Retrieve the 'histsp500' variable from the Python environment
histsp500_py <- py$histsp500

# Convert the Python dataframe to an R dataframe
histsp500_r <- py_to_r(histsp500_py)

# Display the first few rows of the R dataframe
head(histsp500_r)
```

```{r}
py_run_string("x = 10")

# access the python main module via the 'py' object
py$x
```


```{r include=FALSE}
df = read.csv('../../data/sp500_Closing_values.csv')
```


```{r include=FALSE}
head(df)
```


```{r include=FALSE}
# Convert the column to datetime format
df$Date <- ymd_hms(df$Date)
# Extract just the date part
df$Date <- as.Date(df$Date)
```

```{r include=FALSE}
head(df)
```


```{r include=FALSE}
str(df)
```


```{r include=FALSE}
# Create a new column 'relacion' with yesterday's price over today's price
df <- df %>%
  mutate(relacion = lag(Close) / Close)
```


```{r include=FALSE}
head(df)
```

```{r include=FALSE}
# Remove the first row
df <- df[-1, ]
```



En las siguiente Figura se muestra la evolución histórica del valor al cierre de cada día del indicador $S\&P\;500$, desde la fecha 03/01/1928 hasta 08/12/2023.

```{r echo=FALSE}
# Check for any NA or non-finite values in Date or Close
df <- na.omit(df)

# Determine the range of dates
date_range <- range(df$Date, na.rm = TRUE)
```

```{r,label='plot1',echo=FALSE, r,label='plot1'}
# Your ggplot code
ggplot(df, aes(x = Date, y = Close)) +
  geom_line() +
  ggtitle("S&P500: valores diarios históricos al cierre (03/01/1928-08/12/2023)") +
  xlab("fecha") +
  ylab("Precio de cierre") +
  scale_x_date(limits = date_range) +
  theme(
    axis.title.x = element_text(margin = margin(t = 20, b = 40)),
    axis.title.y = element_text(margin = margin(r = 20, l = 40)),
    plot.title = element_text(size = 11)  # Adjust the size parameter as needed
  )
```

```{r echo=FALSE}
dim(df)
```


```{r echo=FALSE}
ggplot(df, aes(x = Date, y = relacion)) +
  geom_line() +
  ggtitle("S&P500: Valores históricos del Indicador (03/01/1928-08/12/2023)") +
  xlab("Fecha") +
  ylab("Valores del Indicador") +
  scale_x_date(limits = date_range) +
  scale_y_continuous(breaks = seq(0, ceiling(max(df$relacion)), by = 0.05)) +
  theme(
    axis.title.x = element_text(margin = margin(t = 20, b = 40)),
    axis.title.y = element_text(margin = margin(r = 20, l = 40)),
    plot.title = element_text(size = 11, hjust = 0.5),  # Center the plot title
    axis.text = element_text(size = 10),  # Adjust the size of axis text
    axis.title = element_text(size = 12),  # Adjust the size of axis titles
    legend.title = element_text(size = 10),  # Adjust the size of legend title
    legend.text = element_text(size = 8)  # Adjust the size of legend text
  )
```




```{r}
ts_relacion=df[,c('relacion')]
```



```{r}
result_adf <- suppressWarnings(adf.test(ts_relacion))
cat('p-valor adf:', result_adf$p.value ,'\n')
```



```{r}
result_kpss <- suppressWarnings(kpss.test(ts_relacion))
cat('p-valor kpss:', result_kpss$p.value ,'\n')
```

```{r}
#install.packages('aTSA')
aTSA::adf.test(ts_relacion)
```




<!-- MARCO TEORICO -->
\newpage

```{r child='marco_teorico.Rmd'}
```

\newpage
<!-- ESTRATEGIA EMPIRICA -->
\section{Estrategia Empírica}





<!-- ###################################### -->
\newpage

\section{Referencias bibliográficas}

<div id="refs"></div>

\newpage 

# Appendix
